---
title: "Untitled"
author: "Christophe Ambroise"
date: "2024-06-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r}
library(ClusterR)
library(tictoc)
library(Rcpp)
sourceCpp("bridge-affinity.cpp")  # Replace with the actual path to your C++ file
X<-iris[,1:4]
spectral_bridges <-  function(X,
                              n_classes = 3,
                              n_nodes = 6,
                              M = 1e3,transform="none") {
  # 1. Vector quantization
  n <- nrow(X)

  kmeans_result  = KMeans_rcpp(X, clusters = n_nodes, 
                               num_init = 1, max_iters = 1, 
                               initializer = 'kmeans++')
  
  kmeans_centers <- as.matrix(kmeans_result$centroids)
  kmeans_labels <-  as.matrix(kmeans_result$clusters)
  kmeans_size <-  kmeans_result$obs_per_cluster

  # 2. Affinity computation
  affinity <- matrix(0, n_nodes, n_nodes)
  X.centered <-
    as.matrix(do.call(rbind, lapply(1:n, function(i) {
      X[i, ] - kmeans_centers[kmeans_labels[i], ]
    })))
  
tic()  

 affinity <- outer(1:n_nodes, 1:n_nodes,
                    Vectorize(function(k, l) {
                      distkl2<- (sum(((kmeans_centers[l,] - kmeans_centers[k, ]))^2))
                      nk<-kmeans_size[k]
                      nl<-kmeans_size[l]
                      sigma<-sqrt((nk*kmeans_Iw[k]+nl*kmeans_Iw[l])/(nk+nl))
                      ifelse(k == l,
                             0, 
                              sigma^2/(sum(pmax(0, (kmeans_centers[l,] - kmeans_centers[k, ]) %*% 
                                         t(X.centered[(kmeans_labels ==k), ]))/distkl2 - nl/(nk+nl)*sqrt(distkl2))^2  +
                              sum(pmax(0, (kmeans_centers[k,] - kmeans_centers[l, ]) %*% 
                                         t(X.centered[(kmeans_labels ==l), ]))/distkl2 - nk/(nk+nl)*sqrt(distkl2))^2 ) / (nk+nl))}))
 
affinity <- outer(1:n_nodes, 1:n_nodes,
                    Vectorize(function(k, l) {
                      ifelse(k == l,
                             0,
                             ((sum(pmax(
                               0, (kmeans_centers[l,] - kmeans_centers[k, ]) %*% t(X.centered[(kmeans_labels ==
                                                                                                 k), ])
                             )^1) +
                               sum(pmax(
                                 0, (kmeans_centers[k,] - kmeans_centers[l, ]) %*% t(X.centered[(kmeans_labels ==
                                                                                                   l), ])
                               )^1)) /
                               (sum((kmeans_centers[k,] - kmeans_centers[l, ])^2)^1 * (kmeans_size[k] + kmeans_size[l]))))
          }))

toc()


mem<-affinity

tic() 
#kmeans_centers.centered<-scale(kmeans_centers,center = TRUE,scale=FALSE)
#kmeans_centers_norm_matrix <- matrix(apply(kmeans_centers.centered,1,function(x) #sum(x^2)),n_nodes, n_nodes)


norm_diff<-matrix(0,n_nodes, n_nodes)
affinity <- matrix(0, n_nodes, n_nodes)
# Compute the affinity matrix
for (k in 1:n_nodes) {
  for (l in k:n_nodes) {
    if (k != l) {
      diff_kl<-kmeans_centers[k,] - kmeans_centers[l, ]
      norm_diff[k, l]<-sum(diff_kl^2)
      term1 <- sum(pmax(0, diff_kl %*% t(X.centered[kmeans_labels == k, ])))
      term2 <- sum(pmax(0, -diff_kl %*% t(X.centered[kmeans_labels == l, ])))
      affinity[k, l] <- (term1 + term2) / (norm_diff[k, l] * (kmeans_size[k] + kmeans_size[l]))
      affinity[l, k]<-affinity[k, l]
    }
  }
}
toc()
print(sum(affinity-mem))

tic()
affinity_matrix <- compute_affinity(kmeans_centers, kmeans_labels, X.centered, kmeans_size,n_nodes)$affinity
toc()


print(affinity)
print(affinity_matrix)
}

spectral_bridges(X,3,6)


```

## Bridge version 2 

K-means clustering assigns a class to each point based on its proximity to a central point, called a centroid. As a result, the boundary that separates two classes is a hyperplane. This hyperplane is orthogonal to the line segment connecting the centroids of the two classes and intersects this segment at its midpoint.

We introduce the concept of Bridge affinity between two classes, $k$
 and $l$, which is determined by the mean distance of points to the hyperplane that separates these classes. This formulation draws a parallel to the concept of the support vector margin, emphasizing the geometric characterization of cluster separation. 

 
 
 
 Visualizing the segment as a bridge, we define for each point $\boldsymbol x \in kl$ the distance required to reach the center of the bridge, denoted as  $\boldsymbol \mu_{kl} = \frac{1}{2}(\boldsymbol \mu_k+\boldsymbol \mu_l)$. This formulation draws a parallel to the concept of the support vector margin, emphasizing the geometric characterization of cluster separation. 

Let us denote $\boldsymbol p_{kl}(\boldsymbol x)$ the projection of $\boldsymbol x \in k$ onto the segment $[\boldsymbol \mu_k,\boldsymbol \mu_l]$: 
$$
\boldsymbol p_{kl}(\boldsymbol x) = \boldsymbol \mu_{k} + t(\boldsymbol \mu_{l} - \boldsymbol \mu_{k}),
$$
with 
$$
t  = \min\left(1, \max\left(0, \frac{\langle \boldsymbol x - \boldsymbol \mu_k | \boldsymbol \mu_l - \boldsymbol \mu_k\rangle}{\|  \boldsymbol \mu_l - \boldsymbol \mu_k \|^2}\right)\right). 
$$
The 'bridge distance'  for a point $\boldsymbol x \in k$ is 
$$
\|\boldsymbol p_{kl}(\boldsymbol x) - \boldsymbol \mu_{kl}\| = (1/2-t) \| \boldsymbol \mu_k-\boldsymbol \mu_l \|.
$$
The ratio $\frac{\|\boldsymbol p_{kl}(\boldsymbol x) - \boldsymbol \mu_{kl}\|}{\| \boldsymbol \mu_k-\boldsymbol \mu_k \|}$ acts as a dissmilarity. If the average ratio is large it suggests a low density between the classes. Conversely, if this average  ratio is small, it indicates that the two classes may reside within the same densely populated region.  

We then define the bridge affinity as a fonction of this ratio between the bridge distance and the length of the bridge
$$
 t_{kl}(\boldsymbol x) =  1/2- \frac{\|\boldsymbol p_{kl}(\boldsymbol x) - \boldsymbol \mu_{kl}\|}{\| \boldsymbol \mu_k-\boldsymbol \mu_l \|}.
$$

The bridge affinity between two classes  $k$ and $l$ is defined as the mean bridge affinity of all points of classes  $k$, $l$:

$$
a_{kl} =\sum_{\boldsymbol x \in kl} t_{kl}(\boldsymbol x)= \frac{\sum_{\boldsymbol{x} \in k} \langle \boldsymbol{x} - \boldsymbol{\mu}_k \vert \boldsymbol{\mu}_l - \boldsymbol{\mu}_k \rangle_+ + \sum_{\boldsymbol{x} \in l} \langle \boldsymbol{x} - \boldsymbol{\mu}_l \vert \boldsymbol{\mu}_k - \boldsymbol{\mu}_l\rangle_+}{(\#P_k + \#P_l) \lVert \boldsymbol{\mu}_k - \boldsymbol{\mu}_l \rVert^2}.
$$


